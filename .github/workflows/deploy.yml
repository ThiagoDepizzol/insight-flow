name: Deploy Spring Boot via SSM

on:
  push:
    branches:
      - release   # sua branch de deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # 1️⃣ Pegar o código
      - name: Checkout código
        uses: actions/checkout@v4

      # 2️⃣ Configurar Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3️⃣ Build Spring Boot (ignorar testes)
      - name: Build Spring Boot
        run: mvn clean package -DskipTests

      # 4️⃣ Verificar se o JAR foi criado
      - name: Verificar JAR
        run: |
          echo "Arquivos no target:"
          ls -l target/
          # Pega o primeiro JAR que existir
          JAR_FILE=$(ls target/*.jar | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "Nenhum JAR encontrado, build falhou!"
            exit 1
          fi
          echo "JAR encontrado: $JAR_FILE"
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV

      # 5️⃣ Configurar credenciais AWS
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6️⃣ Subir JAR para S3
      - name: Upload JAR para S3
        run: |
          echo "Upload do JAR para S3"
          aws s3 cp "$JAR_FILE" s3://${{ secrets.S3_BUCKET_NAME }}/app.jar --region ${{ secrets.AWS_REGION }}

      # 7️⃣ Deploy na EC2 via SSM
      - name: Deploy na EC2 via SSM
        run: |
          aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"mkdir -p /home/ec2-user/app\",
              \"aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/app.jar /home/ec2-user/app/app.jar --region ${{ secrets.AWS_REGION }}\",
              \"pkill -f app.jar || true\",
              \"nohup java -jar /home/ec2-user/app/app.jar > /home/ec2-user/app/app.log 2>&1 &\"
            ]"
