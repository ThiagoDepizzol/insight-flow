name: Deploy Spring Boot via SSM

on:
  push:
    branches:
      - release   # branch de deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # 1️⃣ Checkout do código
      - name: Checkout código
        uses: actions/checkout@v4

      # 2️⃣ Configurar Java 21
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3️⃣ Build do projeto Spring Boot
      - name: Build Spring Boot
        run: mvn clean package -DskipTests

      # 4️⃣ Verificar se o JAR foi criado
      - name: Verificar JAR
        run: |
          echo "Conteúdo da pasta target:"
          ls -l target/

          JAR_FILE=$(ls target/*.jar | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "ERRO: Nenhum JAR encontrado!"
            exit 1
          fi

          echo "JAR encontrado: $JAR_FILE"
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV

      # 5️⃣ Configurar credenciais AWS
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6️⃣ Upload do JAR para o S3
      - name: Upload JAR para S3
        run: |
          echo "Enviando JAR para o S3..."
          aws s3 cp "$JAR_FILE" s3://${{ secrets.S3_BUCKET_NAME }}/app.jar

      # 7️⃣ Deploy automático na EC2 via SSM
      - name: Deploy na EC2 via SSM
        run: |
          echo "Realizando deploy na EC2..."

          aws ssm send-command \
            --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Spring Boot App" \
            --parameters 'commands=[
              "echo === INICIANDO DEPLOY ===",
              "sudo mkdir -p /home/ubuntu/app",
              "echo Baixando novo app.jar do S3...",
              "sudo aws s3 cp s3://'${{ secrets.S3_BUCKET_NAME }}'/app.jar /home/ubuntu/app/app.jar",
              "echo Parando aplicação antiga...",
              "sudo pkill -f app.jar || true",
              "echo Iniciando nova aplicação...",
              "cd /home/ubuntu/app",
              "sudo nohup java -jar app.jar > app.log 2>&1 &",
              "sleep 10",
              "echo === STATUS ===",
              "ps aux | grep java",
              "echo === LOG ===",
              "tail -n 50 /home/ubuntu/app/app.log"
            ]' \
            --region ${{ secrets.AWS_REGION }}

      # 8️⃣ Mensagem final
      - name: Deploy finalizado
        run: echo "Deploy concluído com sucesso!"
