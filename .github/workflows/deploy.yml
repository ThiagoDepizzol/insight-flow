name: Deploy Spring Boot via SSM

on:
  push:
    branches:
      - release # Branch de deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # 1️⃣ Checkout do código
      - name: Checkout código
        uses: actions/checkout@v4

      # 2️⃣ Configurar Java 21
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3️⃣ Build do projeto
      - name: Build Spring Boot
        run: mvn clean package -DskipTests

      # 4️⃣ Localizar o JAR gerado
      - name: Localizar JAR
        run: |
          echo "Conteúdo da pasta target:"
          ls -l target/

          JAR_FILE=$(ls target/*.jar | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "ERRO: nenhum JAR encontrado"
            exit 1
          fi

          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "JAR encontrado: $JAR_FILE"

      # 5️⃣ Configurar credenciais AWS
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6️⃣ Upload do JAR para o S3
      - name: Upload JAR para S3
        run: |
          echo "Enviando app.jar para o S3..."
          aws s3 cp "$JAR_FILE" s3://${{ secrets.S3_BUCKET_NAME }}/app.jar

      # 7️⃣ Deploy na EC2 via SSM
      - name: Deploy na EC2
        run: |
          echo "Executando deploy na EC2..."

          aws ssm send-command \
            --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Insight Flow App" \
            --parameters 'commands=[
              "echo === INICIO DO DEPLOY ===",
              "sudo mkdir -p /home/ubuntu/app",
              "echo Baixando nova versão do S3...",
              "sudo aws s3 cp s3://'${{ secrets.S3_BUCKET_NAME }}'/app.jar /home/ubuntu/app/app.jar",
              "echo Parando versão antiga...",
              "sudo pkill -f app.jar || true",
              "echo Iniciando nova versão...",
              "cd /home/ubuntu/app",
              "sudo nohup env DB_URL='\''${{ secrets.DB_URL }}'\'' DB_USERNAME='\''${{ secrets.DB_USERNAME }}'\'' DB_PASSWORD='\''${{ secrets.DB_PASSWORD }}'\'' java -jar app.jar > app.log 2>&1 &",
              "sleep 10",
              "echo === PROCESSOS JAVA ===",
              "ps aux | grep java",
              "echo === LOG ===",
              "tail -n 50 /home/ubuntu/app/app.log"
            ]' \
            --region ${{ secrets.AWS_REGION }}

      # 8️⃣ Final
      - name: Deploy finalizado
        run: echo "Deploy realizado com sucesso!"
